{% extends "board/base.html" %}
{% block title %}{{ board.label }}{% endblock %}

{% block trail %}
<a href="{% url board-detail owner_username=owner.username board_name=board.name %}">{{ board.name }}</a> >
{% endblock %}

{% block heading %}
    {{ axes }} Grid
{% endblock %}

{% block main %}
<section id="board">
    <ul class="menu" id="menu">
        {% if allows_rearrange %}
        <li>
            <a id="new-card-link" href="#new-card-form">New card…</a>
        </li>
        {% endif %}
        {% for bag in bags %}
            {% if bag.name != axes %}
            <li>
                <a href="{% url card-grid  owner_username=board.owner.username board_name=board.name axes=bag.name %}">{{ bag.name }}</a>
            </li>
            {% endif %}
        {% endfor %}
    </ul>
    <table id="card-grid">
        <thead>
            <tr>
                {% if axes.y_axis %}
                <td></td>
                {% endif %}
                {% for tags in axes.x_axis_tag_sets %}
                <th>
                    {% if tags %}
                        {% for tag in tags %}
                            {{ tag.name }}
                        {% endfor %}
                    {% else %}
                        –
                    {% endif %}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in grid.rows %}
            <tr>
                {% for bin in row.bins %}
                    {% if forloop.first and axes.y_axis %}
                    <th>
                        {% for tag in bin.tags %}
                            {{ tag.name }}{% if not forloop.last %},{% endif %}
                        {% empty %}
                            –
                        {% endfor %}
                    </th>
                    {% endif %}
                <td>
                    {% if allows_rearrange %}
                    <form class="card_arrangement" action="{% url card-arrangement board_id=board.id axes=axes %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="tags" value="{{ bin.tags|join:"," }}" />
                        <input name="order" />
                        <input name="dropped" />
                        <input type="submit" value="Rearrange" />
                    </form>
                    {% endif %}
                    <ul id="{{ bin.element_id }}" class="card-bin">
                        {% for card in bin.cards %}
                        <li id="card-{{ card.id }}">
                            {% if allows_rearrange %}
                            <a href="{% url edit-card owner_username=owner.username board_name=board.name axes=axes card_name=card.name %}">
                                <b>{{ card.name }}</b>
                                <q>{{ card.label }}</q>
                            </a>
                            {% else %}
                            <b>{{ card.name }}</b>
                            <q>{{ card.label }}</q>
                            {% endif %}
                            {% for tag in card.tag_set.all %}
                                {% if tag.bag not in axes.x_axis and tag.bag not in axes.y_axis  %}
                                <i>{{ tag }}</i>
                                {% endif %}
                            {% endfor %}
                        </li>
                        {% endfor %}
                    </ul>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% if allows_rearrange %}
<section id="editor">
    <form id="new-card-form" action="{% url new-card owner_username=owner.username board_name=board.name axes=axes %}" method="POST">
        {% with form=new_card_form %}
            {% include "board/form-part.html" %}
            <div class="buttons">
                <input type="submit" value="Create Card">
            </div>
        {% endwith %}
    </form>
</section>
{% endif %}
{% endblock %}

{% block javascripts %}
<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script type="text/javascript"src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/board.js"></script>

{% if allows_rearrange %}
<script type="text/javascript">
    $(function () {
        CardGrid.enableRearrange(
            '.card-bin',
            '{% url card-arrangement-ajax board_id=board.id axes=axes %}');
        CardGrid.makeNewCardButtonMagic();
    });
</script>
{% endif %}
{% if is_polling_enabled %}
<script type="text/javascript">
    CardGrid.pollForUpdates('{% url events-ajax board_id=board.id start_seq=next_seq %}');
</script>
{% endif %}
{% if messages %}
<script type="text/javascript">
    CardGrid.addCloseButtonToMessages();
</script>
{% endif %}
{% endblock %}